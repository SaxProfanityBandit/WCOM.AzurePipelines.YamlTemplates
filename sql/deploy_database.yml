variables:
  azureFirewallRule: '$(Build.Repository.Name)-$(Build.BuildNumber)'
  connectionString: coalesce({{ parameters.connectionString }}, 'Server=tcp:${{ parameters.serverName }}.database.windows.net,1433;Initial Catalog=${{ parameters.databaseName }};Authentication=Active Directory Default;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;')

steps:
- task: AzureCLI@2
  displayName: Deploy $(Build.Repository.Name) Artifact to environment."
  inputs:
    azureSubscription: '${{ parameters.azureSubscription }}'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript:  |
      az sql server firewall-rule create -g ${{ parameters.resourceGroup }} -s ${{ parameters.serverName }} -n "$(azureFirewallRule)" --start-ip-address ${{ parameters.agentPublicIP }} --end-ip-address  ${{ parameters.agentPublicIP }}
      ./tools/sqlpackage /Action:Publish -p:ScriptDatabaseCompatibility=true /SourceFile:"$(Pipeline.Workspace)/$(Build.Repository.Name)/${{ parameters.databaseName }}.dacpac" /TargetConnectionString:"$(connectionString)/Profile:"$(Pipeline.Workspace)/$(Build.Repository.Name)/${{ parameters.databaseName }}.publish.xml"
      result=$?
      az sql server firewall-rule delete -g ${{ parameters.resourceGroup }} -s ${{ parameters.serverName }} -n "$(azureFirewallRule)"
      exit $result